<!doctype html>
<html class="docs-version-current" lang="ko" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kooku&#39;s log RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kooku&#39;s log Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KVSM4B0KPY"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KVSM4B0KPY",{})</script>
<link rel="alternate" type="application/rss+xml" href="/retrospect/rss.xml" title="Kooku&#39;s log RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/retrospect/atom.xml" title="Kooku&#39;s log Atom Feed"><title data-rh="true">06 영속성 어댑터 구현하기 | Kooku&#x27;s log</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kooku0.github.io/docs/books/get-your-hands-dirty-on-clean-architecture/06/"><meta data-rh="true" name="docusaurus_locale" content="ko"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="ko"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="06 영속성 어댑터 구현하기 | Kooku&#x27;s log"><meta data-rh="true" name="description" content="1장에서 전통적인 계층형 아키텍처에 대해 부정적으로 이야기하면서 이 아키텍처에서는 결국 모든 것이 영속성 계층에 의존하게 되어 &#x27;데이터베이스 주도 설계&#x27;가 된다고 이야기 했다."><meta data-rh="true" property="og:description" content="1장에서 전통적인 계층형 아키텍처에 대해 부정적으로 이야기하면서 이 아키텍처에서는 결국 모든 것이 영속성 계층에 의존하게 되어 &#x27;데이터베이스 주도 설계&#x27;가 된다고 이야기 했다."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kooku0.github.io/docs/books/get-your-hands-dirty-on-clean-architecture/06/"><link data-rh="true" rel="alternate" href="https://kooku0.github.io/en/docs/books/get-your-hands-dirty-on-clean-architecture/06/" hreflang="en"><link data-rh="true" rel="alternate" href="https://kooku0.github.io/docs/books/get-your-hands-dirty-on-clean-architecture/06/" hreflang="ko"><link data-rh="true" rel="alternate" href="https://kooku0.github.io/docs/books/get-your-hands-dirty-on-clean-architecture/06/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.13b6080a.css">
<link rel="preload" href="/assets/js/runtime~main.abfe6fdd.js" as="script">
<link rel="preload" href="/assets/js/main.9da62596.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">본문으로 건너뛰기</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/favicon.ico" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Kooku&#x27;s log</b></a><a class="navbar__item navbar__link" href="/blog/">블로그</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/books/">책</a><a class="navbar__item navbar__link" href="/retrospect/">회고</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kooku0/kooku0.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" checked="" class="toggleScreenReader_g2nN" aria-label="어두운 모드와 밝은 모드 전환하기 (현재 어두운 모드)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="맨 위로 스크롤하기" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/books/">Index</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/books/clean-code/introduction/">클린코드</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/books/object/introduction/">오브젝트</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/books/frameworkless-front-end-development/introduction/">프레임워크 없는 프론트엔드 개발</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/books/get-your-hands-dirty-on-clean-architecture/introduction/">만들면서 배우는 클린 아키텍처</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/introduction/">책 소개</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/01/">01 계층형 아키텍처의 문제는 무엇일까?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/02/">02 의존성 역전하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/03/">03 코드 구성하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/04/">04 유스케이스 구현하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/05/">05 웹 어댑터 구현하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/06/">06 영속성 어댑터 구현하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/07/">07 아키텍처 요소 테스트하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/08/">08 경계간 매핑하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/09/">09 애플리케이션 조립하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/10/">10 아키텍처 경계 강제하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/11/">11 의식적으로 지름길 사용하기</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/books/get-your-hands-dirty-on-clean-architecture/12/">12 아키텍처 스타일 결정하기</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/books/functional-programming-in-scala/introduction/">스칼라로 배우는 함수형 프로그래밍</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/books/effective-typescript/introduction/">이펙티브 타입스크립트</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/books/the-pragmatic-programmer/introduction/">실용주의 프로그래머</a></div></li></ul></nav><button type="button" title="사이드바 숨기기" aria-label="사이드바 숨기기" class="button button--secondary button--outline collapseSidebarButton_cwdi"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_xORG"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/">🏠</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">만들면서 배우는 클린 아키텍처</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docs/books/get-your-hands-dirty-on-clean-architecture/06/">06 영속성 어댑터 구현하기</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">이 페이지에서</button></div><div class="theme-doc-markdown markdown"><header><h1>06 영속성 어댑터 구현하기</h1></header><p>1장에서 전통적인 계층형 아키텍처에 대해 부정적으로 이야기하면서 이 아키텍처에서는 결국 모든 것이 영속성 계층에 의존하게 되어 &#x27;데이터베이스 주도 설계&#x27;가 된다고 이야기 했다.<br>
<!-- -->이번 장에서는 다른 계층이 영속성 계층에 의존하지 않도록 의존성을 역전시키기 위해 영속성 계층을 애플리케이션 계층의 플러그인으로 만드는 방법을 살펴보겠다.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="의존성-역전">의존성 역전<a class="hash-link" href="#의존성-역전" title="제목으로 바로 가기">​</a></h2><p>다음 그림은 영속성 어댑터가 애플리케이션 서비스에 영속성 기능을 제공하기 위해 어떻게 의존성 역전 원칙을 적용할 수 있을지 보여준다.
<img loading="lazy" alt="img" src="/assets/images/6.1-5065137ca46491c95d6ca9368526f86a.png" width="870" height="249"></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>코어의 서비스가 영속성 어댑터에 접근하기 위해 포트를 사용한다.</p></div></div><p>애플리케이션 서비스에서는 영속성 기능을 사용하기 위해 포트 인터페이스를 호출한다. 이 포트는 실제로 영속성 작업을 수행하고 데이터베이스와 통신할 책임을 가진 영속성 어댑터 클래스에 의해 구현된다.</p><p>육각형 아키텍처에서 영속성 어댑터는 &#x27;주도되는&#x27; 혹은 &#x27;아웃고잉&#x27; 어댑터다. 애플리케이션에 의해 호출될 뿐, 애플리케이션을 호출하지는 않기 때문이다.</p><p>포트는 사실상 애플리케이션 서비스와 영속성 코드 사이의 간접적인 계층이다. 영속성 문제에 신경쓰지 않고 도메인 코드를 개발하기 위해, 즉 영속성 계층에 대한 코드 의존성을 없애기 위해 이러한 간접 계층을 추가하고 있다는 사실을 잊지 말자. 이렇게 되면 영속성 코드를 리팩터링하더라도 코어 코드를 변경하는 결과로 이어지지 않는다.</p><p>자연스럽게 런타임에는 의존성은 애플리케이션 코어에서 영속성 어댑터로 향한다.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="영속성-어댑터의-책임">영속성 어댑터의 책임<a class="hash-link" href="#영속성-어댑터의-책임" title="제목으로 바로 가기">​</a></h2><p>영속성 어댑터는 일반적으로 어떤 일을 하는가? 01. 입력을 받는다. 02. 입력을 데이터베이스 포멧으로 매핑한다. 03. 입력을 데이터베이스로 보낸다. 04. 데이터베이스 출력을 애플리케이션 포맷으로 매핑한다. 05. 출력을 반환한다.</p><p>영속성 어댑터는 포트 인터페이스를 통해 입력을 받는다. 입력 모델은 인터페이스가 지정한 도메인 엔티티나 특정 데이터베이스 연산 전용 객체가 될 것이다.</p><p>그러고 나서 영속성 어댑터는 데이터베이스를 쿼리하거나 변경하는 데 사용할 수 있는 포맷으로 입력 모델을 매핑한다. 자바 프로젝트에서는 데이터베이스와 통신할 때 일반적으로 JPA를 사용하기 때문에 입력 모델을 데이터베이스 테이블 구조를 반영한 JPA 엔티티 객체로 매핑할 것이다.</p><p>핵심은 영속성 어댑터의 입력 모델이 영속성 어댑터 내부에 있는 것이 아니라 애플리케이션 코어에 있기 때문에 영속성 어댑터 내부를 변경하는 것이 코어에 영향을 미치지 않는다는 것이다.</p><p>다음으로 영속성 어댑터는 데이터베이스에 쿼리를 날리고 쿼리 결과를 받아온다.</p><p>마지막으로, 데이터베이스 응답을 포트에 정의된 출력 모델로 매핑해서 반환한다. 다시 한번 말하지만, 출력 모델이 영속성 어댑터가 아니라 애플리케이션 코어에 위치하는 것이 중요하다.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="포트-인터페이스-나누기">포트 인터페이스 나누기<a class="hash-link" href="#포트-인터페이스-나누기" title="제목으로 바로 가기">​</a></h2><p>서비스를 구현하면서 생기는 의문은 데이터베이스 연산을 정의하고 있는 포트 인터페이스를 어떻게 나눌 것인가다.</p><p>특정 엔티티가 필요로 하는 모든 데이터베이스 연산을 하나의 리포지토리 인터페이스에 넣어 두는게 일반적인 방법이다.</p><p><img loading="lazy" alt="img" src="/assets/images/6.2-b5f2a2309837dc1642b94b6e9d28ef9f.png" width="872" height="257"></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>하나의 아웃고잉 포트 인터페이스에 모든 데이터베이스 연산을 모아두면 모든 서비스가 실제로는 필요하지 않은 메서드에 의존하게 된다.</p></div></div><p>그럼 데이터베이스 연산에 의존하는 각 서비스는 인터페이스에서 단 하나의 메서드만 사용하더라도 하나의 &#x27;넓은&#x27; 포트 인터페이스에 의존성을 갖게 된다. 코드에 불필요한 의존성이 생겼다는 뜻이다.</p><p>필요하지 않는 메서드에 생긴 의존성은 코드를 이해하고 테스트하기 어렵게 만든다.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>&quot;필요없는 화물을 운반하는 무언가에 의존하고 있으면 예상하지 못했던 문제가 생길 수 있다.&quot;</p></div></div><p>인터페이스 분리 원칙(Interface Segregation Principle, ISP)은 이 문제의 답을 제시한다. 이 원칙은 클라이언트가 오로지 자신이 필요로 하는 메서드만 알면 되도록 넓은 인터페이스를 특화된 인터페이스로 분리해야 한다고 설명한다.</p><p><img loading="lazy" alt="img" src="/assets/images/6.3-8c4005d701be0f5e5ad370c311299179.png" width="869" height="282"></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>인터페이스 분리 원칙을 적용하면 불필요한 의존성을 제거하고 기존 의존성을 눈에 더 잘 띄게 만들 수 있다.</p></div></div><p>이제 각 서비스는 실제로 필요한 메서드만 의존한다. 나아가 포트의 이름이 포트의 역할을 명확하게 잘 표현하고 있다. 테스트에서는 어떤 메서드를 모킹할지 고민할 필요가 없다. 왜냐하면 대부분의 경우 포트당 하나의 메서드만 있을 것이기 때문이다.</p><p>물론 모든 상황에 &#x27;포트 하나당 하나의 메서드&#x27;를 적용하지는 못할 것이다. 응집성이 높고 함께 사용될 때가 많기 때문에 하나의 인터페이스에 묶고 싶은 데이터베이스 연산들이 있을 수 있다.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="영속성-어댑터-나누기">영속성 어댑터 나누기<a class="hash-link" href="#영속성-어댑터-나누기" title="제목으로 바로 가기">​</a></h2><p>이전 그림에서는 모든 영속성 포트를 구현한 단 하나의 영속성 어댑터 클래스가 있었다. 그러나 모든 영속성 포트를 구현하는 한, 하나 이상의 클래스 생성을 금지하는 규칙은 없다. 다음과 같이 영속성 연산이 필요한 도메인 클래스(또는 DDD에서의 애그리거트) 하나당 하나의 영속성 어댑터를 구현하는 방식을 선택할 수 있다.</p><p><img loading="lazy" alt="img" src="/assets/images/6.4-485c09de0b5b3dc0cc69f2cb9d0d489c.png" width="867" height="284"></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>하나의 애그리거트당 하나의 영속성 어댑터를 만들어서 여러 개의 영속성 어댑터를 만들 수도 있다.</p></div></div><p>이렇게 하면 영속성 어댑터들은 각 영속성 기능을 이용하는 도메인 경계를 따라 자동으로 나눠진다.</p><p>도메인 코드는 영속성 포트에 의해 정의된 명세를 어떤 클래스가 충족시키는지에 관심없다는 사실을 기억하자. 모든 포트가 구현돼 있기만 한다면 영속성 계층에서 하고 싶은 어떤 작업이든 해도 된다.</p><p>&#x27;애그리거트당 하나의 영속성 어댑터&#x27; 접근 방식 또한 나중에 여러 개의 바운디드 컨텍스트의 영속성 요구사항을 분리하기 위한 좋은 토대가 된다.</p><p><img loading="lazy" alt="img" src="/assets/images/6.5-e172da36221ab762322e0cd2fd50bac4.png" width="889" height="612"></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>바운디드 컨텍스트 간의 경계를 명확하게 구분하고 싶다면 각 바운디드 컨텍스트가 영속성 어댑터(들)을 하나씩 가지고 있어야 한다.</p></div></div><p>각 바운디드 컨텍스트는 영속성 어댑터를 하나씩 가지고 있다. &#x27;바운디드 컨텍스트&#x27;라는 표현은 경계를 암시한다. account 맥락의 서비스가 billing 맥락의 영속성 어댑터에 접근하지 않고, 반대로 billing의 서비스도 account의 영속성 어댑터에 접근하지 않는다는 의미다. 어떤 맥락이 다른 맥락에 있는 무엇인가를 필요로 한다면 전용 인커밍 포트를 통해 접근해야 한다.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="스프링-데이터-jpa-예제">스프링 데이터 JPA 예제<a class="hash-link" href="#스프링-데이터-jpa-예제" title="제목으로 바로 가기">​</a></h2><p>앞의 그림에서 본 AccountPersistenceAdapter를 구현한 코드를 보자. 이 어댑터는 데이터베이스로부터 계좌를 가져오거나 저장할 수 있어야 한다.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_BvAR">AccountPersistenceAdapter</div><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package buckpal.domain;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@AllArgsConstructor(access = AccessLevel.PRIVATE)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class Account {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Getter private final AccountId id;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Getter private final ActivityWindow activityWindow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private final Money baselineBalance;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public static Account withoutId(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Money baselineBalance,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ActivityWindow activityWIndow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return new Account(null, baselineBalance, activityWindow);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public static Account withId(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    AccountId accountId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Money baselineBalance,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ActivityWindow activityWindow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return new Account(accountId, baselineBalance, activityWindow);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public Money calculateBalance() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public boolean withdraw(Money money, AccountId targetAccountId) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public boolean deposit(Money money, AccountId sourceAccountId) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><p>Account 클래스는 getter와 setter만 가진 간단한 데이터 클래스가 아니며 최대한 불변성을 유지하려 한다는 사실을 상기하자.</p><p>데이터베이스와의 통신에 스프링 데이터 JPA를 사용할 것이므로 계좌의 데이터베이스 상태를 표현하는 <code>@Entity</code> 애너테이션이 추가된 클래스도 필요하다.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package buckpal.adapter.persistence;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Entity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Table(name = &quot;account&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class AccountJpaEntity {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @GeneratedValue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private long id;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><p>다음은 activity 테이블을 표현하기 위한 코드다.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package buckpal.adapter.persistence;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Entity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Table(name = &quot;activity&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ActivityJpaEntity {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @GeneratedValue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private Long id;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Column private LocalDateTime timestamp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Column private Long ownerAccountId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Column private Long sourceAccountId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Column private Long targetAccountId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Column private Long amount;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><p>이 단계에서는 계좌의 상태가 ID 하나만으로 구성돼 있다. 나중에 사용자 ID 같은 필드가 추가될 것이다. 좀 더 흥미로운 엔티티는 특정 계좌에 대한 모든 활동을 들고 있는 ActivityJpaEntity다. JPA의 <code>@MoneyToOne</code>이나 <code>@OneToMany</code> 애너테이션을 이용해 ActivityJpaEntity와 AccountJpaEntity를 연결해서 관계를 표현할 수도 있었겠지만 데이터베이스 쿼리에 부수효과가 생길 수 있기 때문에 일단 이 부분은 제외하기로 결정했다.</p><p>다음으로 기본적인 CRUD 기능과 데이터베이스에서 활동들을 로드하기 위한 커스텀 쿼리를 제공하는 리포지토리 인터페이스를 생성하기 위해 스프링 데이터를 사용한다.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface AccountRepository extends JpaRepository&lt;AccountJpaEntity, Long&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><p>다음은 ActivityRepository 코드다.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_BvAR">ActivityRepository</div><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface ActivityRepository extends JpaRepository&lt;ActivityJpaEntity, Long&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Query(&quot;select a from ActivityJpaEntity a &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;where a.awnerAccountId = :ownerAccountId &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;and a.timestamp &gt;= :since&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  List&lt;ActivityJpaEntity&gt; findByOwnerSince(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Param(&quot;ownerAccountId&quot;) Long ownerAccountId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Param(&quot;since&quot;) LocalDateTime since</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Query(&quot;selct sum(a.amount) from ActivityJpaEntity a &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;where a.targetAccountId = :accountId &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;and a.ownerAccountId = :accountId &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;and a.timestamp &lt; :unit&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Long getDepositBalanceUntil(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Param(&quot;accountId&quot;) Long accountId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Param(&quot;until&quot;) LocalDateTime until</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Query(&quot;select sum(a.amount) from ActivityJpaEntity a &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;where a.sourceAccountId = :accountId &quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;and a.ownerAccountId = :accountId&quot; +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;and a.timestamp &lt; :until&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Long getWithdrawalBalanceUntil(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Param(&quot;accountId&quot;) Long accountId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Param(&quot;until&quot;) LocalDateTime until</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><p>스프링 부트는 이 리포지토리를 자동으로 찾고, 스프링 데이터는 실제로 데이터베이스와 통신하는 리포지토리 인터페이스 구현체를 제공하는 마법을 부린다.</p><p>JPA 엔티티와 리포지토리를 만들었으니 영속성 기능을 제공하는 영속성 어댑터를 구현해보자.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@RequireArgsConstructor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class AccountPersistenceAdapter implements LoadAccountPort, UpdateAccountStatePort {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private final AccountRepository accountRepository;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private final ActivityRepository activityRepository;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private final AccountMapper accountMapper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public Account loadAccount(AccountId accountId, LocalDateTime baselineDate) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    AccountJpaEntity account = accountRepository</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      .findById(accountId.getValue())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      .orElseThrow(EntityNotFoundException::new);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    List&lt;ActivityJpaEntity&gt; activities =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      activityRepository.findByOwnerSince(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        accountId.getValue(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        baselineDate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Long withdrawalBalance = orZero(activityRepository</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      .getWithdrawalBalanceUntil(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        accountId.getValue(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        baselineDate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Long depositBalance = orZero(activityRepository</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      .getDepositBalanceUntil(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        accountId.getValue(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        baselineDate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return accountMapper.mapToDomainEntity(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      account,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      activities,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      withdrawalBalance,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      depositBalance</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  private Long orZero(Long value) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return value == null ? 0L : value;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public void updateActivities(Account account) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for (Activity activity : account.getActivityWindow().getActivities()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      if (activity.getId() == null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        activityRepository.save(accountMapper.mapToJpaEntity(activity));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><p>영속성 어댑터는 애플리케이션에 필요한 LoadAccountPort와 UpdateAccountStatePort라는 2개의 포트를 구현했다.</p><p>데이터베이스로부터 계좌를 가져오기 위해 AccountRepository로 계좌를 불러온 다음, ActivityRepository로 해당 계좌의 특정 시간 범위 동안의 활동을 가져온다.</p><p>계좌의 상태를 업데이트하기 위해서는 Account 엔티티의 모든 활동을 순회하며 ID가 있는지 확인해야 한다. 만약 ID가 없다면 새로운 활동이므로 ActivityRepository를 이용해 저장해야 한다.</p><p>영속성 측면과의 타협 없이 풍부한 도메인 모델을 생성하고 싶다면 도메인 모델과 영속성 모델을 매핑하는 것이 좋다.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="데이터베이스-트랜잭션은-어떻게-해야-할까">데이터베이스 트랜잭션은 어떻게 해야 할까?<a class="hash-link" href="#데이터베이스-트랜잭션은-어떻게-해야-할까" title="제목으로 바로 가기">​</a></h2><p>트랜잭션 경계는 어디에 위치시켜야 할까?</p><p>트랜잭션은 하나의 특정한 유스케이스에 대해서 일어나는 모든 쓰기 작업에 걸쳐 있어야한다. 그래야 그중 하나라도 실패할 경우 다 같이 롤백될 수 있기 때문이다.</p><p>영속성 어댑터는 어떤 데이터베이스 연산이 같은 유스케이스에 포함되는지 알지 못하기 때문에 언제 트랜잭션을 열고 닫을지 결정할 수 없다. 이 책임은 영속성 어댑터 호출을 관장하는 서비스에 위임해야 한다.</p><p>자바와 스프링에서 가장 쉬운 방법은 <code>@Transactional</code> 애너테이션을 애플리케이션 서비스 클래스에 붙여서 스프링이 모든 public 메서드를 트랜잭션으로 감싸게 하는 것이다.</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package buckpal.application.service;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class SendMoneyService implements SendMoneyUseCase {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="클립보드에 코드 복사" class="copyButton_wuS7 clean-btn">복사</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="유지보수-가능한-소프트웨어를-만드는-데-어떻게-도움이-될까">유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?<a class="hash-link" href="#유지보수-가능한-소프트웨어를-만드는-데-어떻게-도움이-될까" title="제목으로 바로 가기">​</a></h2><p>도메인 코드에 플러그인처럼 동작하는 영속성 어댑터를 만들면 도메인 코드가 영속성과 관련된 것들로부터 분리되어 풍부한 도메인 모델을 만들 수 있다.</p><p>좁은 포트 인터페이스를 사용하면 포트마다 다른 방식으로 구현할 수 있는 유연함이 생긴다. 심지어 포트 뒤에서 애플리케이션이 모르게 다른 영속성 기술을 사용할 수도 있다. 포트의 명세만 지켜진다면 영속성 계층 전체를 교체할 수도 있다.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kooku0/kooku0.github.io/edit/main/docs/books/get-your-hands-dirty-on-clean-architecture/06.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>페이지 편집</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="문서 탐색"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/books/get-your-hands-dirty-on-clean-architecture/05/"><div class="pagination-nav__sublabel">이전</div><div class="pagination-nav__label">05 웹 어댑터 구현하기</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/books/get-your-hands-dirty-on-clean-architecture/07/"><div class="pagination-nav__sublabel">다음</div><div class="pagination-nav__label">07 아키텍처 요소 테스트하기</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#의존성-역전" class="table-of-contents__link toc-highlight">의존성 역전</a></li><li><a href="#영속성-어댑터의-책임" class="table-of-contents__link toc-highlight">영속성 어댑터의 책임</a></li><li><a href="#포트-인터페이스-나누기" class="table-of-contents__link toc-highlight">포트 인터페이스 나누기</a></li><li><a href="#영속성-어댑터-나누기" class="table-of-contents__link toc-highlight">영속성 어댑터 나누기</a></li><li><a href="#스프링-데이터-jpa-예제" class="table-of-contents__link toc-highlight">스프링 데이터 JPA 예제</a></li><li><a href="#데이터베이스-트랜잭션은-어떻게-해야-할까" class="table-of-contents__link toc-highlight">데이터베이스 트랜잭션은 어떻게 해야 할까?</a></li><li><a href="#유지보수-가능한-소프트웨어를-만드는-데-어떻게-도움이-될까" class="table-of-contents__link toc-highlight">유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog/">블로그</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/books/">책</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/kooku0/kooku0.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/mingyu-gu-25aa761b5/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 kooku's log, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.abfe6fdd.js"></script>
<script src="/assets/js/main.9da62596.js"></script>
</body>
</html>